{{#extend 'layout.html'}}



{{block code}}

    {{if isinstance( code, str ):
        codes = [ code ]
      else:
        codes = code
      pass
    }}

{{  is_placeholder=[]
    
    for nr, code in enumerate(codes):
        if code.lower().startswith('###placeholder\n\n'):
            is_placeholder.append( 'true' )
            codes[nr] = code[len('###placeholder\n\n'):]
              
        else:
            is_placeholder.append( 'false' )
        pass
    pass
}}          

    <script>
            var placeholders = {};
            
            
            function highlight_placeholder( cm, state ){
                // highlights background by  correctness state
                colors = {
                    'initial': '#FFFFA9',
                    'wrong': '#FFC0CB',
                    'ok': '#BBF8BB'
                    };
                cm.getScrollerElement().style.background = colors[ state ]  ;  // https://codemirror.net/doc/manual.html Ctrl+F: doc.addLineClass
            }

            function show_hint( cm, hints ){
                cm.getScrollerElement().title = hints;  // if hints is ""  should do some trick to prevent balloon with previous contents
                //$(".CodeMirror-scroll").balloon();  //needs balloon activation once

            }

            window.onload = function () {
                placeholders['{{=task_key}}'] = [];
                
            {{  for nr, code in enumerate(codes):}}
                    cm = CodeMirror.fromTextArea(document.getElementById('code_{{=nr}}'), {
                        mode: "python",
                        theme: "default"
                        ,height: "dynamic"
                        // ,viewportMargin: Infinity  // https://codemirror.net/demo/resize.html
                        //, lineNumbers: true
                        , readOnly: !{{= is_placeholder[nr] }} 
                    });
                    cm.getScrollerElement().style.maxHeight = {{ =code.count('\n')*16+25 }};
                    cm.getScrollerElement().style.minHeight = {{ =code.count('\n')*16+25 }};
                    if ({{=is_placeholder[nr]}} ) {
                        highlight_placeholder(cm, "initial");
                        placeholders['{{=task_key}}'].push( cm );
                        show_hint(cm, "kažką reik pakeisti");
                    }

                    cm.refresh();
                    
            {{  pass }}

                    $(".CodeMirror-scroll").balloon();  // activate hints via el title

            
        };
    


    function placeholders_on_submit(task_key){
        placeholders[task_key].forEach( function ( cm ) {
            cm.save()
            highlight_placeholder(cm,  "initial")
        }); 
    }
    </script>
    
    <form action="{{=URL('tutor', 'evaluate')}}" method="POST">
    {{  placeholder_nr = 0     }}
    {{  for nr, code in enumerate(codes):}}
       {{ extra = {}; 
          if is_placeholder[nr]=="true":
              #extra['_name']="placeholder_%s"%placeholder_nr  
              extra['_name']="placeholder"

              placeholder_nr += 1
          pass
       }}
       {{ =TEXTAREA( code, _rows=code.count('\n'), _cols=50, _id="code_%s"%nr, **extra)  }}  
    {{  pass }}

    {{=INPUT(_type="hidden", _name="task_key", _value=task_key)}}
    
<!--
    {{=INPUT(_type="submit", _value="dbg")}}
-->

    {{ # if we have placeholders to enter, add "Submit" button }}
    {{  if [1 for  x  in  is_placeholder if x == 'true']: }}
        {{  
            # save state to textarea
            js_save = "placeholders_on_submit('%s'); "%task_key
            # call stuff
            js_get_hints = "ajax('%s', ['task_key', 'placeholder'], 'results'); "% URL('tutor', 'evaluate')  # deprecated -- for debug purposes
            js_highligth = "ajax('%s', ['task_key', 'placeholder'], ':eval'); "% URL('tutor', 'evaluate', vars={'change_placeholders':1} )
        }}
        {{=INPUT(_type="submit", _onclick= js_save+js_get_hints + js_highligth +" return false;" )}}
    {{ pass }}
     </form>  

<div id="results"> </div>
{{end}}

